# [컴퓨터 구조와 운영체제]CPU 성능 향상 기법2-명령어 병렬 처리 기법

빠른 CPU를 만들려면 높은 클럭 속도에 멀티코어, 멀티스레드를 지원하는 CPU를 만드는 것도 중요하지만, CPU가 놀지 않고 시간을 알뜰하게 쓰며 작동하게 만드는 것도 중요함

**명령어 병렬 처리 기법**은 명령어를 동시에 처리하여 CPU를 한시도 쉬지 않고 작동시키는 기법이며, 명령어 병렬 처리 기법에는 명령어 **파이프라이닝, 슈퍼스칼라, 비순차적 명령어 처리**가 있음

## 명령어 파이프라인

- 명령어 처리 과정을 클럭 단위로 나누어 보면 명령어 인출(Instruction Fetch), 명령어 해석(Instruction Decode), 명령어 실행(Excute Instruction), 결과 저장(Write Back)이 있음
- 같은 단계가 겹치지만 않는다면 CPU는 각 단계를 동시에 실행할 수 있음
- **명령어 파이프라이닝**은 동시에 여러 개의 명령어를 겹쳐 실행하는 기법
- 명령어 파이프라이닝은 공장 생산 라인과 같이 명령어 파이프라인에 넣고 동시에 처리하는 기법
- 파이프라이닝은 높은 성능을 가져오지만, 특정 상황에서는 성능 향상에 실패하는데 이러한  상황을 **파이프라인 위험** 이라고 함
- 파이프라인 위험에는 **데이터 위험, 제어 위험, 구조적 위험**이 있음

**데이터 위험**

- **데이터 위험**은 명령어 간 ‘데이터 의존성’에 의해 발생함
- 모든 명령어를 동시에 처리할 수는 없음 → 어떤 명령어는 이전 명령어를 끝까지 실행해야만 비로소 실행할 수 있음
- 데이터 의존적인 두 명령어를 무작정 동시에 실행하려고 하면 파이프라인이 제대로 작동하지 않는 것을 ‘데이터 위험’ 이라고 함

**제어 위험**

- **제어 위험**은 주로 분기 등으로 인한 ‘프로그램 카운터의 갑작스러운 변화’에 의해 발생함
- 기본적으로 프로그램 카운터는 ‘현재 실행 중인 명령어의 다음 주소’ 로 갱신됨
- 제어위험이란 프로그램 실행 흐름이 바뀌어 명령어가 실행되면서 프로그램 카운터 값에 갑작스러운 변화가 생긴다면 명령어 파이프라인에 미리 가지고 와서 처리 중이었던 명령어들은 아무 쓸모가 없어지는 것임
- 이를 위해 사용하는 기술 중 하나가 **분기 예측**이며, 분기 예측은 프로그램이 어디로 분기할지 미리 예측한 후 그 주소를 인출하는 기술

**구조적 위험**

- **구조적 위험**은 명령어들을 겹쳐 실행하는 과정에서 서로 다른 명령어가 동시에 ALU, 레지스터 등과 같은 CPU 부품을 사용하려고 할 때 발생함
- 구조적 위험을 **자원 위험** 이라고도 함

## 슈퍼스칼라

- 파이프라이닝은 단일 파이프라인으로도 구현이 가능하지만, 오늘날 대부분의 CPU에서 여러 개의 파이프라인을 이용함
- **슈퍼스칼라**는 CPU 내부에 여러 개의 명령어 파이프라인을 포함한 구조
- 슈퍼스칼라 프로세서 또는 슈퍼스칼라 CPU는 슈퍼스칼라 구조로 명령어 처리가 가능한 CPU
- 슈퍼스칼라 프로세서는 매 클럭 주기마다 동시에 여러 명령어를 인출할 수도, 실행할 수도 있어야함
- 멀티스레드 프로세서는 한 번에 여러 명령어를 인출하고, 해석하고, 실행할 수 있기 때문에 슈퍼스칼라 구조를 사용할 수 있음
- 슈퍼스칼라 프로세서는 파이프라인 위험 등의 예상치 못한 문제가 있어 실제로는 반드시 파이프라인 개수에 비례하여 빨라지지 않음
- 여러 개의 파이프라인을 이용하면 하나의 파이프라인을 사용할 때보다 데이터 위험, 제어 위험, 자원 위험을 피하기가 더욱 까다로워지므로 고도로 설계되어야 함

## 비순차적 명령어 처리

- 비순차적 명령어 처리 기법(OoOE)는 오늘날 CPU 성능 향상에 크게 기여한 기법이자 대부분의 CPU가 차용하는 기법임
- **비순차적 명령어 처리 기법**은 명령어들을 순차적으로 실행하지 않는 기법
- 명령어들 중에 서로 데이터 의존성이 전혀 없는, 순서를 바꿔 처리해도 수행 결과에 미치지 않는 명령어들이 있음
    - 예를 들어, 6개의 명령어가 클럭 단위로 명령어 인출, 명령어 해석, 명령어 실행, 결과 저장 나뉘어져 처리되고, ①번 명령어는 100번지에 1을 저장하라, ②번 명령어는 101번지에 2를 저장하라, ③번 명령어는 100번지에 1을 저장된 101에 저장된 2를 더하라 라고 가정하자
    - 그 외 ④ ~ ⑥의 명령어가 서로 데이터 의존성이 전혀 없다고 가정했을 때, 명령어를 순차적으로 실행한다면 ③번 명령어를 실행하기 위해 ①과 ②의 명령어 실행이 끝날 때 까지 기다려야 함
    - 하지만 명령어 ③번 명령어를 실행 순서를 ⑥번 뒤로 바꾸어 실행한다면 파이프라인이 멈추지 않고 효율적으로 처리됨
- **비순차적 명령어 처리 기법**은 명령어를 순차적으로만 실행하지 않고 순서를 바꿔 실행해도 무방한 명령어를 먼저 실행하여 명령어 파이프라인이 멈추는 것을 방지하는 기법
- 비순차적 명령어 처리가 가능한 CPU는 명령어들이 어떤 명령어와 데이터 의존성을 가지고 있는지, 순서를 바꿔 실행할 수 있는 명령어에는 어떤 것들이 있는지를 판단할 수 있어야 함 (아무 명령어나 순서를 바꿔서 수행할 수는 없음)

### 참조

위 글은 강민철 님의 혼자 공부하는 컴퓨터구조+운영체제를 읽고 작성한 글입니다. 

[혼자 공부하는 컴퓨터 구조+운영체제](https://search.shopping.naver.com/book/catalog/33824626625)